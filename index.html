<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reply.io Messaging Matrix v7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .code-box { font-family: 'Courier New', monospace; background: #0f172a; color: #38bdf8; border: 1px solid #1e293b; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; background: white !important; }
        .persona-row { transition: all 0.2s; }
        input[type="radio"]:checked + h3 { color: #2563eb; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                    Messaging Matrix <span class="text-blue-600 text-sm bg-blue-50 px-2 py-1 rounded">v7 Pro</span>
                </h1>
                <p class="text-slate-500 text-sm">Drafting Tool for Reply.io Conditional Templates</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                <button onclick="downloadBackup()" class="text-[10px] font-bold px-3 py-1.5 bg-slate-100 rounded-md hover:bg-slate-200 text-slate-700 uppercase">ðŸ’¾ Save Backup</button>
                <button onclick="document.getElementById('importFile').click()" class="text-[10px] font-bold px-3 py-1.5 bg-slate-100 rounded-md hover:bg-slate-200 text-slate-700 uppercase">ðŸ“‚ Load Backup</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importBackup(event)">
                <div class="h-4 w-[1px] bg-slate-200 mx-1"></div>
                <button onclick="clearData()" class="text-[10px] font-bold px-3 py-1.5 text-red-400 hover:text-red-600 uppercase">Reset</button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
            <div class="xl:col-span-7 space-y-4">
                <div class="flex items-center justify-between px-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Select Version to Edit:</span>
                    <div id="version-tabs" class="flex gap-1 bg-slate-200 p-1 rounded-lg">
                        <button onclick="setVersion('A')" id="tab-A" class="tab-btn px-4 py-1 rounded-md text-xs font-bold">A</button>
                        <button onclick="setVersion('B')" id="tab-B" class="tab-btn px-4 py-1 rounded-md text-xs font-bold">B</button>
                        <button onclick="setVersion('C')" id="tab-C" class="tab-btn px-4 py-1 rounded-md text-xs font-bold">C</button>
                        <button onclick="setVersion('D')" id="tab-D" class="tab-btn px-4 py-1 rounded-md text-xs font-bold">D</button>
                        <button onclick="setVersion('E')" id="tab-E" class="tab-btn px-4 py-1 rounded-md text-xs font-bold">E</button>
                        <button onclick="setVersion('F')" id="tab-F" class="tab-btn px-4 py-1 rounded-md text-xs font-bold">F</button>
                    </div>
                </div>

                <div id="matrix-container" class="space-y-3"></div>
                
                <div class="p-4 bg-amber-50 rounded-xl border border-amber-200 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <input type="radio" name="default-radio" id="radio-GlobalDefault" onclick="setDefault('GlobalDefault')">
                            <h3 class="text-xs font-bold text-amber-800 uppercase tracking-wider">Fallback (General Default)</h3>
                        </div>
                    </div>
                    <input type="text" placeholder="Fallback Subject" oninput="saveData('GlobalDefault', 'sub', this.value)" id="input-sub-GlobalDefault" class="w-full p-2.5 mb-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-amber-400">
                    <textarea placeholder="Fallback Body Content" oninput="saveData('GlobalDefault', 'body', this.value)" id="input-body-GlobalDefault" class="w-full p-2.5 border rounded-lg text-sm h-20 outline-none focus:ring-2 focus:ring-amber-400"></textarea>
                </div>
            </div>

            <div class="xl:col-span-5">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200 sticky top-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Live Preview</h2>
                        <select id="preview-persona" onchange="updateUI()" class="text-xs border-none bg-slate-100 rounded-md p-1 font-bold"></select>
                    </div>
                    
                    <div class="space-y-4 mb-8">
                        <div id="preview-subject" class="p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 italic"></div>
                        <div id="preview-body" class="p-4 border rounded-xl bg-white min-h-[160px] whitespace-pre-wrap text-sm text-slate-800 shadow-inner overflow-y-auto max-h-64"></div>
                        <div id="char-count" class="text-right text-[10px] font-black"></div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <button onclick="exportCode('subject')" class="flex-1 bg-slate-900 text-white text-[11px] py-3 rounded-lg hover:bg-black font-black uppercase tracking-tight transition">Export Subject</button>
                            <button onclick="exportCode('body')" class="flex-1 bg-blue-600 text-white text-[11px] py-3 rounded-lg hover:bg-blue-700 font-black uppercase tracking-tight transition">Export Body</button>
                        </div>
                        <div class="relative">
                            <textarea id="output-code" class="code-box w-full h-32 p-4 rounded-xl text-[10px] leading-relaxed" readonly placeholder="Liquid code..."></textarea>
                            <button onclick="copyBtn()" id="copy-btn" class="absolute top-2 right-2 bg-slate-700 text-white px-3 py-1 rounded text-[10px] hover:bg-slate-600">COPY</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const personas = ["AI Security", "AI Governance", "CISO", "CAIO", "AWS Solution Architect"];
        const versions = ["A", "B", "C", "D", "E", "F"];
        let currentVersion = "A";
        let defaultPersonaId = "GlobalDefault";
        let data = {};

        function loadData() {
            const saved = localStorage.getItem('reply_v7_data');
            const savedDefault = localStorage.getItem('reply_v7_default');
            if (saved) {
                data = JSON.parse(saved);
            } else {
                data = { "GlobalDefault": {} };
                [...personas, "GlobalDefault"].forEach(p => {
                    data[p] = {};
                    versions.forEach(v => { data[p][v] = { sub: "", body: "" }; });
                });
            }
            if (savedDefault) defaultPersonaId = savedDefault;
        }

        const container = document.getElementById('matrix-container');
        const pSelector = document.getElementById('preview-persona');

        function init() {
            loadData();
            personas.forEach((p) => {
                const div = document.createElement('div');
                div.className = "p-4 bg-white rounded-xl border border-slate-200 persona-row shadow-sm";
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-black text-slate-700 uppercase tracking-wider">${p}</h3>
                        <label class="text-[10px] font-bold flex items-center gap-1.5 cursor-pointer text-slate-400">
                            <input type="radio" name="default-radio" ${defaultPersonaId === p ? 'checked' : ''} onclick="setDefault('${p}')"> SET DEFAULT
                        </label>
                    </div>
                    <input type="text" placeholder="Subject" oninput="saveData('${p}', 'sub', this.value)" id="input-sub-${p}" class="w-full p-2.5 mb-2 border-slate-200 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400">
                    <textarea placeholder="Body" oninput="saveData('${p}', 'body', this.value)" id="input-body-${p}" class="w-full p-2.5 border-slate-200 border rounded-lg text-sm h-16 outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                `;
                container.appendChild(div);
                const opt = document.createElement('option'); opt.value = p; opt.textContent = p; pSelector.appendChild(opt);
            });
            if (defaultPersonaId === "GlobalDefault") document.getElementById('radio-GlobalDefault').checked = true;
            const optD = document.createElement('option'); optD.value = "GlobalDefault"; optD.textContent = "Global Fallback"; pSelector.appendChild(optD);
            setVersion('A');
        }

        function setDefault(id) { defaultPersonaId = id; localStorage.setItem('reply_v7_default', id); }

        function saveData(p, field, val) {
            data[p][currentVersion][field] = val;
            localStorage.setItem('reply_v7_data', JSON.stringify(data));
            updateUI();
        }

        function setVersion(v) {
            currentVersion = v;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById(`tab-${v}`).classList.add('tab-active');
            [...personas, "GlobalDefault"].forEach(p => {
                document.getElementById(`input-sub-${p}`).value = data[p][currentVersion].sub || "";
                document.getElementById(`input-body-${p}`).value = data[p][currentVersion].body || "";
            });
            updateUI();
        }

        function updateUI() {
            const p = pSelector.value;
            const content = data[p][currentVersion];
            const fullBody = `Hi {{FirstName}},\n\n${content.body || ''}`;
            document.getElementById('preview-subject').textContent = content.sub || '-- No Subject --';
            document.getElementById('preview-body').textContent = fullBody;
            const count = fullBody.length;
            const counter = document.getElementById('char-count');
            counter.textContent = `${count} / 300 CHARS`;
            counter.className = count > 300 ? "text-red-500 font-black" : "text-slate-400 font-bold";
        }

        function exportCode(type) {
            let output = (type === 'body') ? "Hi {{FirstName}},\n\n" : "";
            let nested = "";
            personas.forEach(p => {
                nested += `{{#if Persona == '${p}'}}${data[p][currentVersion][type==='body'?'body':'sub']}{{else}}`;
            });
            nested += data[defaultPersonaId][currentVersion][type==='body'?'body':'sub'];
            personas.forEach(() => nested += "{{/if}}");
            document.getElementById('output-code').value = output + nested.trim();
        }

        function downloadBackup() {
            const exportObj = { data, defaultPersonaId };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `messaging_matrix_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const imported = JSON.parse(e.target.result);
                data = imported.data;
                defaultPersonaId = imported.defaultPersonaId;
                localStorage.setItem('reply_v7_data', JSON.stringify(data));
                localStorage.setItem('reply_v7_default', defaultPersonaId);
                location.reload();
            };
            reader.readAsText(file);
        }

        function copyBtn() {
            const area = document.getElementById('output-code');
            area.select(); navigator.clipboard.writeText(area.value);
            const b = document.getElementById('copy-btn');
            b.textContent = "DONE"; setTimeout(() => b.textContent = "COPY", 2000);
        }

        function clearData() { if(confirm("Wipe everything?")) { localStorage.clear(); location.reload(); } }

        init();
    </script>
</body>
</html>
